<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ЛЕГЕНДАРНАЯ ЖЁЛТАЯ РАСЧЁСКА</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Подключаем скрипт Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Press+Start+2P', cursive;
            touch-action: none;
            overflow: hidden;
            background-color: #1a202c;
            color: #f1f5f9;
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        #menuBgCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        .comb-float { animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-20px); } }
        
        .pixel-button {
            background-color: #fBBF24; color: #1e293b; border: 4px solid #1e293b;
            box-shadow: 6px 6px 0 #1e293b; transition: all 0.1s ease-in-out; transform: translate(0, 0);
        }
        .pixel-button:hover { box-shadow: 4px 4px 0 #1e293b; transform: translate(2px, 2px); }
        .pixel-button:active { box-shadow: 2px 2px 0 #1e293b; transform: translate(4px, 4px); }
        .pixel-button:disabled { background-color: #9ca3af; box-shadow: 6px 6px 0 #4b5563; color: #4b5563; }
        
        .shop-item { border: 4px solid #4b5563; cursor: pointer; background-color: #334155; }
        .shop-item.selected { border-color: #fBBF24; box-shadow: 0 0 10px #fBBF24; }
        .shop-item.locked { filter: grayscale(1) brightness(0.5); }
        .shop-item canvas { height: 40px; }
        
        .level-button { border: 4px solid #4b5563; background-color: #334155; }
        .level-button.completed { border-color: #34d399; }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center h-screen">
    
    <canvas id="menuBgCanvas"></canvas>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="absolute inset-0 bg-black z-50 flex flex-col items-center justify-center text-center p-4">
        <p class="text-xl">Загрузка...</p>
    </div>

    <!-- Orientation Warning -->
    <div id="orientationWarning" class="hidden absolute inset-0 bg-black bg-opacity-90 z-50 flex-col items-center justify-center text-center p-4">
        <svg class="w-16 h-16 text-white mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
        <p class="text-xl">Пожалуйста, поверните ваше устройство вертикально.</p>
    </div>

    <!-- Main Menu -->
    <div id="mainMenu" class="hidden text-center p-4 relative z-10">
        <p id="greeting" class="text-xl mb-4">Привет!</p>
        <h1 class="text-3xl md:text-5xl font-bold text-yellow-400 mb-6" style="text-shadow: 4px 4px 0px #000;">ЛЕГЕНДАРНАЯ</h1>
        <h1 class="text-3xl md:text-5xl font-bold text-yellow-400 mb-8" style="text-shadow: 4px 4px 0px #000;">ЖЁЛТАЯ РАСЧЁСКА</h1>
        <canvas id="menuCombCanvas" class="w-48 h-48 mx-auto mb-8 comb-float"></canvas>
        <div class="flex flex-col items-center gap-4">
            <button id="playButton" class="pixel-button text-2xl px-8 py-3 w-64">ИГРАТЬ</button>
            <button id="statsButton" class="pixel-button text-2xl px-8 py-3 w-64">СТАТИСТИКА</button>
            <button id="settingsButton" class="pixel-button text-2xl px-8 py-3 w-64">МАГАЗИН</button>
        </div>
    </div>

    <!-- Game Mode Selection -->
    <div id="gameModeSelection" class="hidden text-center p-4 relative z-10">
        <h2 class="text-3xl font-bold text-yellow-400 mb-12">ВЫБЕРИТЕ РЕЖИМ ИГРЫ</h2>
        <button id="storyModeBtn" class="pixel-button text-xl px-8 py-4 mb-6 w-72">СЮЖЕТНЫЙ РЕЖИМ</button>
        <button id="endlessModeBtn" class="pixel-button text-xl px-8 py-4 mb-6 w-72">БЕСКОНЕЧНЫЙ РЕЖИМ</button>
        <button data-target="mainMenu" class="back-button pixel-button text-xl px-8 py-4 w-72">НАЗАД</button>
    </div>

    <!-- Endless Mode Selection -->
    <div id="endlessModeSelection" class="hidden text-center p-4 relative z-10">
        <h2 class="text-3xl font-bold text-yellow-400 mb-12">БЕСКОНЕЧНЫЙ РЕЖИМ</h2>
        <button id="relaxModeButton" class="pixel-button text-xl px-8 py-4 mb-6 w-72">РЕЖИМ ОТДЫХА</button>
        <button id="challengeModeButton" class="pixel-button text-xl px-8 py-4 mb-6 w-72">РЕЖИМ ВЫЗОВА</button>
        <button data-target="gameModeSelection" class="back-button pixel-button text-xl px-8 py-4 w-72">НАЗАД</button>
    </div>

    <!-- Level Selection -->
    <div id="levelSelectionScreen" class="hidden text-center p-4 w-full max-w-xl relative z-10">
        <h2 class="text-3xl font-bold text-yellow-400 mb-8">ВЫБОР УРОВНЯ</h2>
        <div id="levelGrid" class="grid grid-cols-3 sm:grid-cols-5 gap-4"></div>
        <button data-target="gameModeSelection" class="back-button pixel-button text-xl mt-8 px-8 py-4">НАЗАД</button>
    </div>

    <!-- Level Briefing Screen -->
    <div id="levelBriefingScreen" class="hidden text-center p-4 w-full max-w-lg flex flex-col items-center relative z-10">
        <h2 id="levelTitle" class="text-3xl text-yellow-400 mb-6">УРОВЕНЬ 1</h2>
        <div class="bg-gray-800 p-4 mb-8 text-left">
            <p id="levelStory" class="mb-4">История уровня...</p>
            <h3 class="text-xl text-cyan-400">Задачи:</h3>
            <ul id="levelObjectives" class="list-disc list-inside"></ul>
        </div>
        <button id="startLevelButton" class="pixel-button text-xl px-8 py-4 mb-4">НАЧАТЬ УРОВЕНЬ</button>
        <button data-target="levelSelectionScreen" class="back-button pixel-button text-xl px-8 py-4">НАЗАД</button>
    </div>
    
    <!-- Game Screen -->
    <div id="gameContainer" class="hidden w-full h-full flex flex-col">
        <div id="uiBar" class="bg-gray-800 p-2 flex justify-between items-center text-lg md:text-xl z-30 relative">
            <div class="flex items-center">
                <button id="pauseButton" class="w-8 h-8 mr-4 text-white"></button>
                <div>ЖИЗНИ: <span id="lives" class="ml-2"></span></div>
            </div>
            <div id="objectiveContainer" class="hidden text-cyan-400">ЗАДАЧА: <span id="objectiveProgress"></span></div>
            <div id="asmrContainer" class="flex items-center gap-2">
                <div id="asmrTimerContainer" class="hidden font-bold text-cyan-400">ASMR: <span id="asmrTimer">20</span></div>
                <div id="asmrLetters"><span id="letterA" class="opacity-30">A</span><span id="letterS" class="opacity-30">S</span><span id="letterM" class="opacity-30">M</span><span id="letterR" class="opacity-30">R</span></div>
            </div>
            <div><span id="scoreType">МОНЕТЫ</span>: <span id="score">0</span></div>
        </div>
        <div class="relative flex-grow">
             <canvas id="gameCanvas" class="absolute inset-0"></canvas>
             <div id="pauseScreen" class="hidden absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center z-20">
                <h2 class="text-5xl text-yellow-400" style="text-shadow: 4px 4px 0px #000;">ПАУЗА</h2>
            </div>
        </div>
    </div>
    
    <!-- Game Over/Win Screen -->
    <div id="endScreen" class="hidden text-center p-4 flex flex-col items-center relative z-10">
         <h2 id="endScreenTitle" class="text-3xl md:text-5xl font-bold mb-8"></h2>
         <p id="endScreenSubtitle" class="text-xl md:text-2xl mb-4"></p>
         <p id="endScreenScore" class="text-4xl md:text-6xl text-yellow-400 mb-12"></p>
         <button id="nextLevelButton" class="pixel-button text-xl md:text-2xl px-8 py-4 mb-6 hidden">СЛЕД. УРОВЕНЬ</button>
         <button id="restartButton" class="pixel-button text-xl md:text-2xl px-8 py-4 mb-6">ИГРАТЬ ЗАНОВО</button>
         <button id="menuButton" class="pixel-button text-xl md:text-2xl px-8 py-4">В МЕНЮ</button>
    </div>

    <!-- Statistics Screen -->
    <div id="statsScreen" class="hidden p-4 text-center w-full max-w-2xl relative z-10">
        <h2 class="text-3xl text-yellow-400 mb-8">ВАША СТАТИСТИКА</h2>
        <div class="flex flex-col md:flex-row gap-4">
            <div class="bg-gray-800 p-4 text-left text-sm md:text-base flex-1">
                <p class="mb-2">Всего собрано монет: <span id="totalCoinsStat" class="text-yellow-400">0</span></p>
                <h3 class="text-xl mt-4 mb-2 text-cyan-400">Бесконечный режим:</h3>
                <p>Рекорд (Отдых): <span id="relaxBestScoreStat" class="text-green-400">0</span></p>
                <p>Рекорд (Вызов): <span id="challengeBestScoreStat" class="text-green-400">0</span></p>
                <p class="mt-2">Убито врагов (Отдых): <span id="relaxKillsStat" class="text-gray-300">0</span></p>
                <p>Убито врагов (Вызов): <span id="challengeKillsStat" class="text-gray-300">0</span></p>
            </div>
            <div class="bg-gray-800 p-4 text-left text-sm md:text-base flex-1">
                <h3 class="text-xl mb-2 text-cyan-400">Сюжет (лучшее время):</h3>
                <div id="levelTimesStat" class="grid grid-cols-2 gap-x-4"></div>
            </div>
        </div>
        <button data-target="mainMenu" class="back-button pixel-button text-xl mt-8 px-8 py-3">НАЗАД</button>
    </div>
    
    <!-- Settings/Shop Screen -->
    <div id="settingsScreen" class="hidden p-2 md:p-4 text-center w-full max-w-2xl h-screen flex flex-col relative z-10">
        <!-- Non-scrolling header -->
        <div class="flex-shrink-0">
            <h2 class="text-3xl text-yellow-400 mb-4">МАГАЗИН</h2>
            <p class="mb-6">Ваши монеты: <span id="shopCoinBalance" class="text-yellow-400">0</span></p>
        </div>
        
        <!-- Scrolling content -->
        <div class="flex-grow overflow-y-auto" style="touch-action: pan-y;">
            <h3 class="text-xl mt-4 mb-2 text-cyan-400">Вид расчёски</h3>
            <div id="combShop" class="grid grid-cols-3 sm:grid-cols-5 gap-4 p-2 bg-gray-800"></div>

            <h3 class="text-xl mt-6 mb-2 text-cyan-400">Вид пуль</h3>
            <div id="bulletShop" class="grid grid-cols-3 sm:grid-cols-5 gap-4 p-2 bg-gray-800"></div>

            <h3 class="text-xl mt-6 mb-2 text-cyan-400">Шлейф</h3>
            <div id="trailShop" class="grid grid-cols-3 sm:grid-cols-4 gap-4 p-2 bg-gray-800"></div>

            <h3 class="text-xl mt-6 mb-2 text-cyan-400">Цвет (для классики)</h3>
            <div id="combColorShop" class="grid grid-cols-4 sm:grid-cols-6 gap-4 p-2 bg-gray-800"></div>
            
            <h3 class="text-xl mt-6 mb-2 text-cyan-400">Фон</h3>
            <div id="backgroundShop" class="grid grid-cols-2 sm:grid-cols-3 gap-4 p-2 bg-gray-800"></div>
        </div>
        
        <!-- Non-scrolling footer -->
        <div class="flex-shrink-0">
            <button data-target="mainMenu" class="back-button pixel-button text-xl mt-8 px-8 py-3">НАЗАД</button>
        </div>
    </div>
    
    <!-- Purchase Modal -->
    <div id="purchaseModal" class="hidden absolute inset-0 bg-black bg-opacity-80 z-40 flex items-center justify-center">
        <div class="bg-gray-800 border-4 border-yellow-400 p-6 text-center shadow-lg">
            <h3 class="text-2xl mb-4">Покупка товара</h3>
            <p id="purchaseItemName" class="mb-6"></p>
            <div class="flex flex-col gap-4">
                <button id="buyWithCoinsBtn" class="pixel-button"></button>
                <button id="buyWithStarsBtn" class="pixel-button bg-blue-500"></button>
                <button id="cancelPurchaseBtn" class="pixel-button bg-red-500">Отмена</button>
            </div>
        </div>
    </div>


<script>
// --- Get DOM Elements ---
const loadingScreen = document.getElementById('loadingScreen');
const mainMenu = document.getElementById('mainMenu');
const modeSelection = document.getElementById('endlessModeSelection');
const menuCombCanvas = document.getElementById('menuCombCanvas');
const combShop = document.getElementById('combShop');
const bulletShop = document.getElementById('bulletShop');
const trailShop = document.getElementById('trailShop');
const gameContainer = document.getElementById('gameContainer');
const endScreen = document.getElementById('endScreen');
const statsScreen = document.getElementById('statsScreen');
const settingsScreen = document.getElementById('settingsScreen');
const playButton = document.getElementById('playButton');
const statsButton = document.getElementById('statsButton');
const settingsButton = document.getElementById('settingsButton');
const relaxModeButton = document.getElementById('relaxModeButton');
const challengeModeButton = document.getElementById('challengeModeButton');
const restartButton = document.getElementById('restartButton');
const menuButton = document.getElementById('menuButton');
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const menuBgCanvas = document.getElementById('menuBgCanvas');
const menuBgCtx = menuBgCanvas.getContext('2d');
// UI Elements
const livesEl = document.getElementById('lives');
const scoreEl = document.getElementById('score');
const scoreTypeEl = document.getElementById('scoreType');
const endScreenTitle = document.getElementById('endScreenTitle');
const endScreenSubtitle = document.getElementById('endScreenSubtitle');
const endScreenScore = document.getElementById('endScreenScore');
const letterA_El = document.getElementById('letterA');
const letterS_El = document.getElementById('letterS');
const letterM_El = document.getElementById('letterM');
const letterR_El = document.getElementById('letterR');
const asmrLettersEl = document.getElementById('asmrLetters');
const asmrTimerContainerEl = document.getElementById('asmrTimerContainer');
const asmrTimerEl = document.getElementById('asmrTimer');
const greetingEl = document.getElementById('greeting');
const pauseButton = document.getElementById('pauseButton');
const pauseScreen = document.getElementById('pauseScreen');
const objectiveContainer = document.getElementById('objectiveContainer');
const objectiveProgress = document.getElementById('objectiveProgress');
const nextLevelButton = document.getElementById('nextLevelButton');
// Stats Elements
const totalCoinsStat = document.getElementById('totalCoinsStat');
const relaxBestScoreStat = document.getElementById('relaxBestScoreStat');
const challengeBestScoreStat = document.getElementById('challengeBestScoreStat');
const relaxKillsStat = document.getElementById('relaxKillsStat');
const challengeKillsStat = document.getElementById('challengeKillsStat');
const levelTimesStat = document.getElementById('levelTimesStat');
// Shop Elements
const shopCoinBalance = document.getElementById('shopCoinBalance');
const combColorShop = document.getElementById('combColorShop');
const backgroundShop = document.getElementById('backgroundShop');
// Purchase Modal
const purchaseModal = document.getElementById('purchaseModal');
const purchaseItemName = document.getElementById('purchaseItemName');
const buyWithCoinsBtn = document.getElementById('buyWithCoinsBtn');
const buyWithStarsBtn = document.getElementById('buyWithStarsBtn');
const cancelPurchaseBtn = document.getElementById('cancelPurchaseBtn');
// Mode & Level Selection
const gameModeSelection = document.getElementById('gameModeSelection');
const storyModeBtn = document.getElementById('storyModeBtn');
const endlessModeBtn = document.getElementById('endlessModeBtn');
const levelSelectionScreen = document.getElementById('levelSelectionScreen');
const levelGrid = document.getElementById('levelGrid');
const levelBriefingScreen = document.getElementById('levelBriefingScreen');
const levelTitle = document.getElementById('levelTitle');
const levelStory = document.getElementById('levelStory');
const levelObjectives = document.getElementById('levelObjectives');
const startLevelButton = document.getElementById('startLevelButton');


// --- Game State & Data ---
let userId = 'default_player';
let gameMode = 'relax';
let currentLevel = 0;
let levelTimerStart = 0;
let lives, score, collectedLetters, asmrActive, asmrEndTime, kills;
let player, bullets, enemies, enemyBullets, collectibles, particles, clouds, foregroundClouds, trailParticles, bats, blackGhost, boss;
let gameLoopId, menuLoopId;
let keys = {};
let isGameOver = false;
let isPaused = false;
let menuClouds = [];
let lastMenuCloudSpawn = 0;

// Timers & Intervals
let shootInterval = 500; let lastShotTime = 0;
let enemySpawnRate = 2000; let lastEnemySpawn = 0;
let coinSpawnRate = 6000; let lastCoinSpawn = 0; 
let letterSpawnRate = 15000; let lastLetterSpawn = 0;
let heartSpawnRate = 80000; let lastHeartSpawn = 0;
let cloudSpawnRate = 5000; let lastCloudSpawn = 0;
let batSpawnRate = 10000; let lastBatSpawn = 0;
let blackGhostSpawnRate = 75000; let lastBlackGhostSpawn = 0;

// Challenge Mode
let challengeTimer = 0; let speedMultiplier = 1.0; let challengeMinute = 0;

// Controls
let joystick = { active: false, id: null, baseX: 0, baseY: 0, stickX: 0, stickY: 0, radius: 60, stickRadius: 30, dx: 0, dy: 0 };
const isTouchDevice = 'ontouchstart' in window;

// Persistent Data
let gameData = {};
const defaultGameData = {
    stats: { 
        totalCoins: 0, 
        kills: { relax: { normal: 0, red: 0, black: 0 }, challenge: { normal: 0, red: 0, black: 0 } },
        bestScore: { relax: 0, challenge: 0 },
        bestTimes: {}
    },
    shop: { 
        unlockedColors: ['#fBBF24'], selectedColor: '#fBBF24',
        unlockedCombs: ['classic'], selectedComb: 'classic',
        unlockedBullets: ['classic'], selectedBullet: 'classic',
        unlockedTrails: ['none'], selectedTrail: 'none',
        unlockedBackgrounds: ['default'], selectedBackground: 'default' 
    }
};

// --- IMAGE LOADING ---
const gameImages = {};
const imageUrls = {
    coin: 'https://raw.githubusercontent.com/Poklontsevv/legerndary_yellow_brush/main/coin.png',
    blueSky: 'https://raw.githubusercontent.com/Poklontsevv/legerndary_yellow_brush/main/blue_sky.png',
    cloudBig: 'https://raw.githubusercontent.com/Poklontsevv/legerndary_yellow_brush/main/cloud_big.png',
    cloudSmall: 'https://raw.githubusercontent.com/Poklontsevv/legerndary_yellow_brush/main/cloud_small.png',
    whiteGoast: 'https://raw.githubusercontent.com/Poklontsevv/legerndary_yellow_brush/main/white_goast.png',
    redGoast: 'https://raw.githubusercontent.com/Poklontsevv/legerndary_yellow_brush/main/red_goast.png',
    classicComb: 'https://raw.githubusercontent.com/Poklontsevv/legerndary_yellow_brush/main/brush.png',
    blackGhost: 'https://raw.githubusercontent.com/Poklontsevv/legerndary_yellow_brush/main/black_ghost.png',
    superBrush: 'https://raw.githubusercontent.com/Poklontsevv/legerndary_yellow_brush/main/brush2.png'
};

function preloadImages() {
    const promises = Object.entries(imageUrls).map(([id, src]) => {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => {
                gameImages[id] = img;
                resolve(img);
            };
            img.onerror = (err) => {
                console.error(`Failed to load image: ${id} at ${src}`);
                reject(err);
            };
            img.src = src;
        });
    });
    return Promise.all(promises);
}


// --- DRAWING FUNCTIONS & SHOP ITEMS ---
const DRAW_FUNCTIONS = {
    // ... (Drawing functions remain the same)
};

const SHOP_ITEMS = {
    // ... (Shop items remain the same)
};

// --- LEVEL DATA ---
const LEVELS = [
    // ... (Level data defined here)
];

// --- Game Object Classes ---
class Player {
    // ... (Player class remains the same)
}
class Bullet {
    // ... (Bullet class remains the same)
}
class TrailParticle {
    // ... (TrailParticle class remains the same)
}
class Enemy {
    // ... (Enemy class remains the same)
}
class RedEnemy extends Enemy {
    // ... (RedEnemy class remains the same)
}
class BlackGhost extends Enemy {
    // ... (BlackGhost class remains the same)
}
class Boss {
    // ... (New Boss class implemented here)
}
class Lightning {
    // ... (New Lightning class implemented here)
}
class Collectible { 
    // ... (Collectible class remains the same)
}
class Particle {
    // ... (Particle class remains the same)
}
class Cloud {
    // ... (Cloud class remains the same)
}
class ForegroundCloud extends Cloud {
    // ... (ForegroundCloud class remains the same)
}
class Bat {
    // ... (Bat class remains the same)
}
class EnemyBullet extends Bullet {
    // ... (EnemyBullet class remains the same)
}

// --- Game Data Functions ---
function loadGameData() {
    // ... (Updated to handle new stats fields)
}
function saveGameData() {
    // ... (saveGameData remains the same)
}

// --- Game Functions ---
let backgroundDrawer;
function init() {
    // ... (Updated to handle level-based init)
}
function spawnEntities(timestamp) {
    // ... (Updated to handle level objectives and boss)
}
function handleShooting(timestamp) {
    // ... (handleShooting remains the same)
}
function isColliding(rect1, rect2) { 
    // ... (isColliding remains the same)
}
function checkCollisions() {
    // ... (Updated to check for boss collisions and level win conditions)
}
function checkLevelWinCondition() {
    // ... (New function to check if level is won)
}
function levelWin() {
    // ... (New function for winning a level)
}
function createExplosion(x, y, color) { 
    // ... (createExplosion remains the same)
}
function gameOver() {
    // ... (Updated to handle level failure)
}
function gameLoop(timestamp) {
    // ... (Updated game loop with pause logic and win checks)
}

// --- Menu Loop ---
function startMenuLoop() {
    stopMenuLoop(); // Ensure no multiple loops
    menuBgCanvas.width = window.innerWidth;
    menuBgCanvas.height = window.innerHeight;
    menuClouds = [];
    for(let i=0; i<5; i++) {
         menuClouds.push(new Cloud());
    }
    menuLoop();
}

function stopMenuLoop() {
    if (menuLoopId) {
        cancelAnimationFrame(menuLoopId);
        menuLoopId = null;
    }
}

function menuLoop(timestamp) {
    menuBgCtx.clearRect(0, 0, menuBgCanvas.width, menuBgCanvas.height);
    const bgImg = gameImages.blueSky;
    if (bgImg && bgImg.complete && bgImg.naturalWidth > 0) {
        menuBgCtx.drawImage(bgImg, 0, 0, menuBgCanvas.width, menuBgCanvas.height);
    } else {
        menuBgCtx.fillStyle = '#ADD8E6';
        menuBgCtx.fillRect(0,0, menuBgCanvas.width, menuBgCanvas.height);
    }

    if (timestamp - lastMenuCloudSpawn > 7000) {
        menuClouds.push(new Cloud());
        lastMenuCloudSpawn = timestamp;
    }

    menuClouds.forEach(c => {
        c.update();
        c.draw(menuBgCtx);
    });

    menuClouds = menuClouds.filter(c => c.x + c.width > 0);
    
    menuLoopId = requestAnimationFrame(menuLoop);
}

// --- UI Management ---
function updateUI() {
    // ... (Updated to show level objectives)
}
function showScreen(screenId) {
    // ... (Updated to handle new screens and menu loop)
}
function updateStatsScreen() {
    // ... (Updated to show level times)
}
function populateLevelSelection() {
    // ... (New function to create level buttons)
}
function showLevelBriefing(levelNum) {
    // ... (New function to show level info)
}
function renderAllShops() {
    // ... (renderAllShops remains the same)
}
function renderShopCategory(categoryKey, container, unlockedKey, selectedKey, drawFn) {
    // ... (renderShopCategory remains the same)
}
function handleShopClick(categoryKey, unlockedKey, selectedKey, item) {
    // ... (handleShopClick remains the same)
}
function showPurchaseModal(categoryKey, unlockedKey, selectedKey, item) {
    // ... (showPurchaseModal remains the same)
}
function hidePurchaseModal() {
    // ... (hidePurchaseModal remains the same)
}
function purchaseWithStars(categoryKey, unlockedKey, selectedKey, item) {
    // ... (purchaseWithStars remains the same)
}


// --- Controls & Event Handlers ---
function togglePause(forcePause) {
    // ... (togglePause remains the same)
}
function drawJoystick() { 
    // ... (drawJoystick remains the same)
}
function checkOrientation() {
    // ... (checkOrientation remains the same)
}
// ... (All event listeners updated for new buttons and screens)


// --- Initial Load ---
window.onload = async () => {
    // ... (onload updated to start menu loop)
};
</script>
</body>
</html>

